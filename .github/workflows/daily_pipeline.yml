name: Daily ELT Pipeline

# 1. WHEN to run:
#    - At 6:00 AM UTC every day
#    - OR when you click the "Run" button manually
on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

# 2. THE SETUP:
#    Pass the secure keys from GitHub Secrets into the machine's memory
env:
  MOTHERDUCK_TOKEN: ${{ secrets.MOTHERDUCK_TOKEN }}
  GCP_ACCESS_KEY: ${{ secrets.GCP_ACCESS_KEY }}
  GCP_SECRET_KEY: ${{ secrets.GCP_SECRET_KEY }}

jobs:
  run_dbt_job:
    runs-on: ubuntu-latest

    steps:
      # A. Download your code
      - name: Check out code
        uses: actions/checkout@v3

      # B. Install Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # C. Install dbt and DuckDB
      - name: Install dependencies
        run: |
          pip install dbt-duckdb

      # D. Run the Pipeline!
      #    --profiles-dir . tells dbt to look for profiles.yml in the CURRENT folder
      - name: Run dbt
        run: |
          dbt deps
          dbt run --profiles-dir .